"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[1704],{1704:(K,U,a)=>{a.r(U),a.d(U,{HomePageModule:()=>G});var S=a(8434),s=a(7125),H=a(4341),C=a(33),m=a(467),j=a(6368),h=a(9967),P=a(4287),$=a(5293),b=a(7691),e=a(1360),I=a(505),R=a(3522);const f=(0,a(7464).F3)("PushNotifications",{});var x=a(5621),F=a(3656),N=a(3665);let O=(()=>{var i;class u{constructor(t,n,o,r,d,c){this.firestore=t,this.auth=n,this.alertCtrl=o,this.router=r,this.toastController=d,this.navCtrl=c}initPush(){var t=this;return(0,m.A)(function*(){"granted"===(yield f.checkPermissions()).receive||"granted"===(yield f.requestPermissions()).receive?(f.addListener("registration",function(){var o=(0,m.A)(function*(r){console.log("\u2705 Token FCM:",r.value),yield t.saveToken(r.value)});return function(r){return o.apply(this,arguments)}}()),f.addListener("registrationError",o=>{console.error("\u274c Error al registrar token",o)}),f.addListener("pushNotificationReceived",o=>{console.log("\u{1f4e9} Notificaci\xf3n recibida:",JSON.stringify(o));const r=o.data;"incoming_call"===r.type&&t.showIncomingCallDialog(r),"chat_message"===r.type&&t.presentChatToast(r.name,"Tienes un mensaje nuevo",r.meetingId)}),f.addListener("pushNotificationActionPerformed",o=>{console.log("\u{1f4f2} Notificaci\xf3n abierta:",o);const r=o.notification.data;"incoming_call"===r.type&&(0,P._)(r.meetingId),"chat_message"===r.type&&t.router.navigateByUrl(`/chat/${r.meetingId}`)}),yield f.requestPermissions(),yield f.register()):console.log("\u274c Permiso de notificaciones denegado")})()}showIncomingCallDialog(t){var n=this;return(0,m.A)(function*(){yield(yield n.alertCtrl.create({header:"\u{1f4de} Llamada entrante",message:`${t.name} te est\xe1 llamando`,buttons:[{text:"Rechazar",role:"cancel",handler:()=>{console.log("Llamada rechazada")}},{text:"Contestar",handler:()=>{console.log("Llamada aceptada"),(0,P._)(t.meetingId)}}]})).present()})()}presentChatToast(t,n,o){var r=this;return(0,m.A)(function*(){yield(yield r.toastController.create({message:`${t}: ${n}`,duration:5e3,position:"top",buttons:[{text:"Abrir",handler:()=>{r.navCtrl.navigateForward(`/chat/${o}`)}},{text:"Cerrar",role:"cancel"}]})).present()})()}saveToken(t){var n=this;return(0,m.A)(function*(){const o=n.auth.currentUser;if(!o)return;const r=(0,h.H9)(n.firestore,`users/${o.uid}`);yield(0,h.mZ)(r,{token:t})})()}}return(i=u).\u0275fac=function(t){return new(t||i)(e.KVO(h._7),e.KVO(x.Nj),e.KVO(s.hG),e.KVO(N.Ix),e.KVO(s.K_),e.KVO(F.q9))},i.\u0275prov=e.jDH({token:i,factory:i.\u0275fac,providedIn:"root"}),u})();var M=a(4886),D=a(8761);const T=()=>["/home/add-contact"];function A(i,u){if(1&i){const l=e.RV6();e.j41(0,"ion-item",1),e.bIt("click",function(){const n=e.eBV(l).$implicit,o=e.XpG();return e.Njj(o.openChatWith(n.userId))}),e.j41(1,"ion-label")(2,"h2"),e.EFF(3),e.k0s(),e.j41(4,"p"),e.EFF(5),e.k0s()(),e.j41(6,"ion-button",14),e.bIt("click",function(n){const o=e.eBV(l).$implicit;return e.XpG().startCall(o.userId),e.Njj(n.stopPropagation())}),e.EFF(7," \u{1f4de} "),e.k0s()()}if(2&i){const l=u.$implicit;e.R7$(3),e.JRh(l.name),e.R7$(2),e.JRh(l.phone)}}const E=[{path:"",component:(()=>{var i;class u{constructor(t,n,o,r,d,c,g,v,p){this.contactsService=t,this.authService=n,this.pushService=o,this.apiService=r,this.firestore=d,this.platform=c,this.router=g,this.supabaseService=v,this.alertCtrl=p,this.contacts=[],this.platform.ready().then(()=>{this.pushService.initPush()}),$.R.requestAudioRecordingPermission()}ngOnInit(){var t=this;return(0,m.A)(function*(){var n;t.loadContacts();const o=yield t.authService.getCurrentUser(),r=yield t.contactsService.getUserData(null!==(n=null==o?void 0:o.uid)&&void 0!==n?n:"");t.currentUser=r})()}ionViewWillEnter(){this.loadContacts()}changePhoto(){var t=this;return(0,m.A)(function*(){try{const n=yield b.i7.getPhoto({quality:80,allowEditing:!1,resultType:b.LK.Base64,source:b.ru.Prompt});if(null!=n&&n.base64String){const r=t.supabaseService.base64ToBlob(`data:image/jpeg;base64,${n.base64String}`,"image/jpeg"),d=yield t.supabaseService.uploadProfilePhoto(r,t.currentUser.uid),c=yield t.authService.getCurrentUser(),g=(0,h.H9)(t.firestore,`users/${null==c?void 0:c.uid}`);yield(0,h.mZ)(g,{photoUrl:d}),t.currentUser.photoUrl=d}}catch(n){console.error("Error al cambiar foto:",n)}})()}changeName(){var t=this;return(0,m.A)(function*(){var n,r;yield(yield t.alertCtrl.create({header:"Cambiar nombre",inputs:[{name:"newName",type:"text",placeholder:"Nuevo nombre",value:(null===(n=t.currentUser)||void 0===n?void 0:n.name)||""}],buttons:[{text:"Cancelar",role:"cancel"},{text:"Guardar",handler:(r=(0,m.A)(function*(d){var c;const g=null===(c=d.newName)||void 0===c?void 0:c.trim();if(g){const v=yield t.authService.getCurrentUser(),p=(0,h.H9)(t.firestore,`users/${null==v?void 0:v.uid}`);yield(0,h.mZ)(p,{firstName:g}),t.currentUser.firstName=g}}),function(c){return r.apply(this,arguments)})}]})).present()})()}loadContacts(){this.contactsService.obtenerContactos().subscribe(t=>{this.contacts=t,console.log(t)})}startCall(t){var n=this;return(0,m.A)(function*(){const o=(0,j.A)(),r=yield n.authService.getCurrentUser();if(!r)return;const d=yield n.contactsService.getUserData(r.uid);console.log(d);const c=d.firstName||"Desconocido",g=r.uid,v=(0,h.H9)(n.firestore,`users/${t}`),p=yield(0,h.x7)(v);if(!p.exists())return void console.error("El contacto no existe");const z={token:p.data().token,notification:{title:"Llamada entrante",body:`${c} te est\xe1 llamando`},android:{priority:"high",data:{userId:t,meetingId:o,type:"incoming_call",name:c,userFrom:g}}};try{n.apiService.enviarNotificacion(z).subscribe({next:y=>{console.log("Respuesta:",JSON.stringify(y))},error:y=>{console.log("Respuesta:",JSON.stringify(y))}}),console.log("\u2705 Notificaci\xf3n enviada"),(0,P._)(o)}catch(y){console.error("\u274c Error enviando notificaci\xf3n",y)}})()}openChatWith(t){var n=this;return(0,m.A)(function*(){n.router.navigate(["/chat",t])})()}cerrarSesion(){this.authService.cerrarSesion()}}return(i=u).\u0275fac=function(t){return new(t||i)(e.rXU(I.F),e.rXU(R.K),e.rXU(O),e.rXU(M.J),e.rXU(h._7),e.rXU(F.OD),e.rXU(N.Ix),e.rXU(D.W),e.rXU(s.hG))},i.\u0275cmp=e.VBU({type:i,selectors:[["app-home"]],standalone:!1,decls:25,vars:5,consts:[["slot","end"],[3,"click"],["name","log-out-outline"],[1,"ion-padding"],[1,"profile-card"],["lines","none",1,"ion-align-items-start"],[1,"ion-text-center",2,"margin-right","16px"],[3,"src"],["size","small","fill","clear",3,"click"],["size","small","fill","clear",2,"vertical-align","middle",3,"click"],[3,"click",4,"ngFor","ngForOf"],["vertical","bottom","horizontal","end","slot","fixed"],[3,"routerLink"],["name","add"],["slot","end","color","primary",3,"click"]],template:function(t,n){1&t&&(e.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),e.EFF(3,"Inicio"),e.k0s(),e.j41(4,"ion-buttons",0)(5,"ion-button",1),e.bIt("click",function(){return n.cerrarSesion()}),e.nrm(6,"ion-icon",2),e.k0s()()()(),e.j41(7,"ion-content",3)(8,"ion-card",4)(9,"ion-item",5)(10,"div",6)(11,"ion-avatar"),e.nrm(12,"img",7),e.k0s(),e.j41(13,"ion-button",8),e.bIt("click",function(){return n.changePhoto()}),e.EFF(14," Cambiar foto "),e.k0s()(),e.j41(15,"ion-label")(16,"h2"),e.EFF(17),e.j41(18,"ion-button",9),e.bIt("click",function(){return n.changeName()}),e.EFF(19," Cambiar nombre "),e.k0s()()()()(),e.j41(20,"ion-list"),e.DNE(21,A,8,2,"ion-item",10),e.k0s(),e.j41(22,"ion-fab",11)(23,"ion-fab-button",12),e.nrm(24,"ion-icon",13),e.k0s()()()),2&t&&(e.R7$(12),e.Y8G("src",(null==n.currentUser?null:n.currentUser.photoUrl)||"assets/default-avatar.png",e.B4B),e.R7$(5),e.SpI(" ",(null==n.currentUser?null:n.currentUser.firstName)||"Nombre de usuario"," "),e.R7$(4),e.Y8G("ngForOf",n.contacts),e.R7$(2),e.Y8G("routerLink",e.lJ4(4,T)))},dependencies:[S.Sq,s.mC,s.Jm,s.QW,s.b_,s.W9,s.Q8,s.YW,s.eU,s.iq,s.uz,s.he,s.nf,s.BC,s.ai,s.N7,C.Wk],styles:["#container[_ngcontent-%COMP%]{text-align:center;position:absolute;left:0;right:0;top:50%;transform:translateY(-50%)}#container[_ngcontent-%COMP%]   strong[_ngcontent-%COMP%]{font-size:20px;line-height:26px}#container[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:16px;line-height:22px;color:#8c8c8c;margin:0}#container[_ngcontent-%COMP%]   a[_ngcontent-%COMP%]{text-decoration:none}"]}),u})()}];let B=(()=>{var i;class u{}return(i=u).\u0275fac=function(t){return new(t||i)},i.\u0275mod=e.$C({type:i}),i.\u0275inj=e.G2t({imports:[C.iI.forChild(E),C.iI]}),u})();var L=a(3165);let G=(()=>{var i;class u{}return(i=u).\u0275fac=function(t){return new(t||i)},i.\u0275mod=e.$C({type:i}),i.\u0275inj=e.G2t({imports:[S.MD,H.YN,s.bv,B,L.q1]}),u})()}}]);